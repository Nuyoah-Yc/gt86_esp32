# GT86 ESP32 时钟项目完整文档

## 一、项目简介
本项目基于 ESP32 平台，结合 OLED 屏幕、CAN 总线、油压传感器、RTC 实时时钟等硬件，实现 BRZ/FRS/GT86 车型的多功能仪表显示与数据采集。支持本地显示与 Web 配置，适合 DIY 改装及数据监控。

---

## 二、环境准备
### 硬件需求
- ESP32 开发板
- OLED 屏幕（I2C 接口）
- 按键 x3
- 油压传感器
- MCP2515 CAN 总线模块（SPI 接口）
- DS3231 实时时钟模块（I2C 接口）
- 连接线材等

### 软件需求
- [PlatformIO](https://platformio.org/)（推荐 CLion 插件）
- 驱动库依赖：U8g2、mcp_can、WiFiManager、NTPClient、RTClib、ArduinoJson（已在 `platformio.ini` 配置）

---

## 三、硬件接线说明

### ESP32 主控板接线图

### OLED 屏幕（U8G2库，I2C接口）
- **SCL（时钟）**：GPIO 22
- **SDA（数据）**：GPIO 21
- **RESET**：未连接（U8X8_PIN_NONE）

### 按键配置
- **按钮1**：GPIO 2（带上拉，用于长按切换单位）
- **按钮2**：GPIO 34（带上拉，用于调整小时）
- **按钮3**：GPIO 35（带上拉，用于调整分钟）

### 油压传感器
- **A0**：油压信号输入（模拟输入）

### ADC传感器接口（替代CAN总线）
- **传感器1**：GPIO A1（油温传感器，预留给用户开发）
- **传感器2**：GPIO A2（水温传感器，预留给用户开发）
- **传感器3**：GPIO A3（空燃比/电压传感器，预留给用户开发）

### 实时时钟（RTC，DS3231，I2C接口）
- **SCL**：GPIO 22（与 OLED 共用 I2C 总线）
- **SDA**：GPIO 21（与 OLED 共用 I2C 总线）

### 完整接线表

| 设备/信号         | ESP32 引脚 | 说明                |
|-------------------|------------|---------------------|
| OLED SCL          | 22         | I2C 时钟            |
| OLED SDA          | 21         | I2C 数据            |
| OLED RESET        | -          | 未连接              |
| 按钮1             | 2          | 上拉输入            |
| 按钮2             | 34         | 上拉输入            |
| 按钮3             | 35         | 上拉输入            |
| 油压传感器        | A0         | 模拟输入            |
| ADC传感器1        | A1         | 油温传感器（预留）  |
| ADC传感器2        | A2         | 水温传感器（预留）  |
| ADC传感器3        | A3         | 空燃比/电压传感器（预留）|
| DS3231 SCL        | 22         | I2C 时钟            |
| DS3231 SDA        | 21         | I2C 数据            |

**注意：**
- WiFi 由 ESP32 内部实现，无需外部接线
- MCP2515 CAN模块已移除，改用ADC传感器输入
- A1-A3为预留的ADC传感器接口，用户可根据需要接入相应传感器
- 传感器数据处理函数readSensor1()、readSensor2()、readSensor3()已预留，等待用户实现

---

## 四、按键操作说明

### 按键功能
**处于时钟模式下：**
- **按钮2**：用于调整时钟小时数
- **按钮3**：用于调整分钟数
- **按钮2 + 按钮3**：同时按下切换屏幕模式
- **按住按钮1**：在时钟模式下触发NTP同步，在AFR模式下切换AFR/Lambda显示（温度、压力单位已固定为公制）

### 屏幕模式
系统支持13种显示模式：
- Logo 显示
- 时钟显示
- 油温显示
- 冷却液温度显示
- 油温+冷却液温度显示
- 油压显示
- 空燃比+电压显示
- WiFi 设置界面
- 时钟设置界面
- 单位设置界面
- O2 设置界面

---

## 五、项目结构说明

### 根目录文件

- **platformio.ini**
  PlatformIO 的项目配置文件，定义了开发板类型（esp32dev）、使用的框架（Arduino）、依赖库（如 U8g2、mcp_can、WiFiManager、NTPClient、RTClib）以及源码和数据目录。这是整个项目的核心配置文件。

- **default_spiffs.csv**
  SPIFFS 分区表配置文件，定义了 ESP32 的存储分区布局。

- **get-platformio.py**
  PlatformIO 安装脚本。

### 主要源码目录 `src/`

- **gt86clock.h / gt86clock.cpp**
  主程序头文件和实现文件，包含全局变量定义和主要功能实现。

- **setup.cpp**
  硬件初始化代码，包含串口、引脚、EEPROM、CAN、RTC、WiFi等初始化。

- **loop.cpp**
  主循环逻辑，包含模拟数据生成函数和主要业务逻辑处理。

- **screen.cpp**
  屏幕管理和显示控制相关代码。

- **drawClock.cpp**
  时钟界面绘制功能。

- **drawSettings.cpp**
  设置界面绘制功能。

- **webserver.cpp**
  Web 服务器实现，提供 HTTP 接口和 Web 配置界面。

- **interrupts.cpp**
  按钮中断服务程序。

- **handleModeButton.cpp**
  按钮模式切换处理逻辑。

- **logos.h**
  图标和 logo 的位图数据定义。

- **my_functions.h**
  自定义函数声明和工具函数。

### 静态资源目录 `data/`

- **index.html**
  Web 配置界面主页面。

- **favicon.ico**
  网站图标。

- **js/**
  存放 JavaScript 文件。

- **css/**
  存放 CSS 样式文件。

### 其他目录

- **include/**：头文件目录
- **lib/**：自定义库目录
- **test/**：测试目录
- **.idea/**：CLion/ReSharper C++ IDE 配置目录

---

## 六、编译与上传

1. 使用 VSCode 打开本项目文件夹
2. 安装 PlatformIO 插件
3. 连接 ESP32 开发板至电脑
4. 检查 `platformio.ini`，确认开发板型号与端口设置
5. 点击 PlatformIO 的"Build"进行编译
6. 点击"Upload"上传固件
7. 若需上传网页资源，使用 PlatformIO 的"Upload File System image"功能，将 `data/` 目录内容烧录至 SPIFFS

---

## 七、功能说明

### 屏幕与按键操作
- 默认显示时钟、油温、冷却液温度、油压、AFR、电压等信息
- 按钮操作详见第四章按键操作说明

### Web 配置界面
- 设备上电后，连接其 WiFi 热点（如有配置 WiFiManager）
- 浏览器访问 `192.168.4.1` 或设备分配到的 IP 地址
- 进入 Web 配置界面，可进行：
  - 时间同步（NTP）
  - 显示模式切换（Logo、时钟、油温、冷却液温度、油压、AFR、电压、设置等）
  - 时间制式（24h/12h）、AFR 显示方式（AFR/Lambda）切换（温度和压力已固定为公制单位：摄氏度和BAR）

### 传感器监控
- **油压监控**：通过 A0 引脚读取模拟信号
- **ADC 传感器**：A1-A3预留给用户自定义传感器接入
- **时钟功能**：DS3231 RTC 提供精确时间，支持 NTP 网络同步
- **WiFi 连接**：支持 WiFiManager 自动配置

---

## 八、常见问题与注意事项

### 模拟数据
- **重要**：模拟数据在 `loop.cpp` 中的 `void updateSimulatedSensorData()` 函数生成
- **实际应用时请注释此函数调用以关闭模拟数据**

### 故障排除
- **库依赖**：首次编译会自动下载依赖库，若失败请检查网络或手动安装
- **SPI/I2C 引脚**：部分开发板引脚可能需自定义，请参考实际板卡原理图
- **Web 页面无法访问**：请确认设备已连接 WiFi，或尝试重启
- **ADC 传感器问题**：检查传感器接线和电压范围，确保在ESP32的ADC输入范围内（0-3.3V）
- **时钟不准确**：检查 DS3231 模块连接或进行 NTP 同步

### 开发建议
- 使用串口监视器查看调试信息
- 通过 Web 界面实时监控传感器数据
- 根据实际需求扩展传感器、显示内容及 Web 配置项

---

## 九、技术参数

### 硬件规格
- **主控**：ESP32-WROOM-32
- **显示**：128x32 OLED（I2C）
- **通信**：CAN 总线（500K bps）
- **时钟**：DS3231 RTC（±2ppm 精度）
- **存储**：SPIFFS 文件系统
- **WiFi**：802.11 b/g/n

### 软件特性
- **看门狗**：60秒硬件看门狗防死机
- **中断**：按钮中断响应
- **多任务**：Arduino 框架 + FreeRTOS
- **网络**：HTTP Web 服务器 + NTP 时间同步
- **配置**：EEPROM 非易失性存储

---

## 十、参考与扩展

- 项目开源地址：[Github](https://github.com/mg-arne/gt86clock)
- 可根据实际需求扩展传感器、显示内容及 Web 配置项
- 支持其他车型的 CAN 协议扩展
- 可添加更多传感器接口（温度、压力、转速等）

---

**版权说明：** 本项目基于开源协议，欢迎改进和扩展。使用时请注意安全，确保正确接线以避免损坏设备。