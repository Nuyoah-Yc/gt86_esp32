# GT86 ESP32 时钟项目完整文档

## 一、项目简介
本项目基于 ESP32 平台，结合 OLED 屏幕、油压传感器、RTC 实时时钟等硬件，实现 BRZ/FRS/GT86 车型的基础仪表显示与数据采集。专注于本地显示功能，适合 DIY 改装。

---

## 二、环境准备
### 硬件需求
- ESP32 开发板
- OLED 屏幕（I2C 接口）
- 按键 x3
- 油压传感器
- DS3231 实时时钟模块（I2C 接口）
- 连接线材等

### 软件需求
- [PlatformIO](https://platformio.org/)（推荐 CLion 插件）
- 驱动库依赖：U8g2、RTClib（已在 `platformio.ini` 配置）

---

## 三、硬件接线说明

### ESP32 主控板接线图

### OLED 屏幕（U8G2库，I2C接口）
- **SCL（时钟）**：GPIO 22
- **SDA（数据）**：GPIO 23
- **RESET**：未连接（U8X8_PIN_NONE）

### 按键配置
- **按钮1**：GPIO 5（带上拉，用于切换页面）
- **按钮2**：GPIO 18（带上拉，用于调整小时）
- **按钮3**：GPIO 19（带上拉，用于调整分钟）

### ADC传感器接口（替代CAN总线）
- **传感器1**：GPIO 33（油压传感器）
- **传感器2**：GPIO 34（油温传感器）
- **传感器2**：GPIO 32（涡轮压力传感器）
- **传感器2**：GPIO 35（水温传感器）

### 实时时钟（RTC，DS3231，I2C接口）
- **SCL**：GPIO 22（与 OLED 共用 I2C 总线）
- **SDA**：GPIO 23（与 OLED 共用 I2C 总线）

### 完整接线表

| 设备/信号      | ESP32 引脚 | 说明         |
|------------|----------|------------|
| OLED SCL   | 22       | I2C 时钟     |
| OLED SDA   | 23       | I2C 数据     |
| 按钮1        | 5        | 上拉输入       |
| 按钮2        | 18       | 上拉输入       |
| 按钮3        | 19       | 上拉输入       |
| ADC传感器1    | 33       | 油压传感器  |
| ADC传感器2    | 34       | 油温传感器  |
| ADC传感器3    | 32       | 涡轮压力传感器 |
| ADC传感器4    | 35       | 水温传感器 |
| DS3231 SCL | 22       | I2C 时钟     |
| DS3231 SDA | 23       | I2C 数据     |

**注意：**
- A1-A3为预留的ADC传感器接口，用户可根据需要接入相应传感器
- 传感器数据处理函数readSensor1()、readSensor2()、readSensor3()已预留，等待用户实现

---

## 四、按键操作说明

### 按键功能
**处于时钟模式下：**
- **按钮2**：用于调整时钟小时数
- **按钮3**：用于调整分钟数
- **按钮1**：切换页面

### 屏幕模式
系统支持6种显示模式：
- Logo 显示
- 时钟显示
- 油温显示
- 冷却液温度显示
- 油温+冷却液温度显示
- 油压显示

---

## 五、项目结构说明

### 根目录文件

- **platformio.ini**
  PlatformIO 的项目配置文件，定义了开发板类型（esp32dev）、使用的框架（Arduino）、依赖库（如 U8g2、RTClib）以及源码目录。这是整个项目的核心配置文件。


- **get-platformio.py**
  PlatformIO 安装脚本。

### 主要源码目录 `src/`

- **gt86clock.h / gt86clock.cpp**
  主程序头文件和实现文件，包含全局变量定义和主要功能实现。

- **setup.cpp**
  硬件初始化代码，包含串口、引脚、EEPROM、CAN、RTC、WiFi等初始化。

- **loop.cpp**
  主循环逻辑，包含模拟数据生成函数和主要业务逻辑处理。

- **screen.cpp**
  屏幕管理和显示控制相关代码。

- **drawClock.cpp**
  时钟界面绘制功能。


- **interrupts.cpp**
  按钮中断服务程序。

- **handleModeButton.cpp**
  按钮模式切换处理逻辑。

- **logos.h**
  图标和 logo 的位图数据定义。

- **my_functions.h**
  自定义函数声明和工具函数。

### 静态资源目录
静态资源目录已移除（原Web功能已删除）。

### 其他目录

- **include/**：头文件目录
- **lib/**：自定义库目录
- **test/**：测试目录
- **.idea/**：CLion/ReSharper C++ IDE 配置目录

---

## 六、编译与上传

1. 使用 CLion 打开本项目文件夹
2. 安装 PlatformIO 插件
3. 连接 ESP32 开发板至电脑
4. 检查 `platformio.ini`，确认开发板型号与端口设置
5. 点击 PlatformIO 的"Build"进行编译
6. 点击"Upload"上传固件

---

## 七、功能说明

### 屏幕与按键操作
- 默认显示时钟、油温、冷却液温度、油压等信息
- 按钮操作详见第四章按键操作说明

### 传感器监控
- **ADC 传感器**：A1-A3预留给用户自定义传感器接入
- **时钟功能**：DS3231 RTC 提供精确时间

---

## 八、常见问题与注意事项

### 模拟数据
- **重要**：模拟数据在 `loop.cpp` 中的 `void updateSimulatedSensorData()` 函数生成
- **实际应用时请注释此函数调用以关闭模拟数据**

### 故障排除
- **库依赖**：首次编译会自动下载依赖库，若失败请检查网络或手动安装
- **SPI/I2C 引脚**：部分开发板引脚可能需自定义，请参考实际板卡原理图
- **ADC 传感器问题**：检查传感器接线和电压范围，确保在ESP32的ADC输入范围内（0-3.3V）
- **时钟不准确**：检查 DS3231 模块连接

### 开发建议
- 使用串口监视器查看调试信息
- 根据实际需求扩展传感器和显示内容

---

## 九、技术参数

### 硬件规格
- **主控**：ESP32-WROOM-32
- **显示**：128x32 OLED（I2C）
- **时钟**：DS3231 RTC（±2ppm 精度）

### 软件特性
- **看门狗**：60秒硬件看门狗防死机
- **中断**：按钮中断响应
- **多任务**：Arduino 框架 + FreeRTOS
- **配置**：EEPROM 非易失性存储

---

## 十、参考与扩展

- 项目开源地址：[Github](https://github.com/mg-arne/gt86clock)
- 可根据实际需求扩展传感器和显示内容
- 可添加更多传感器接口（温度、压力、转速等）

---

**版权说明：** 本项目基于开源协议，欢迎改进和扩展。使用时请注意安全，确保正确接线以避免损坏设备。