# GT86 ESP32 时钟项目完整文档

## 一、项目简介
本项目基于 ESP32 平台，结合 OLED 屏幕、MCP2515 CAN 总线模块、RTC 实时时钟等硬件，实现 BRZ/FRS/GT86 车型的基础仪表显示与数据采集。通过 CAN 总线读取车辆 ECU 数据，显示机油温度、冷却液温度等信息。

---

## 二、环境准备
### 硬件需求
- ESP32 开发板
- OLED 屏幕（I2C 接口，128x32）
- MCP2515 CAN 总线模块（带 TJA1050 收发器）
- 按键 x3
- DS3231 实时时钟模块（I2C 接口）
- 连接线材等

### 软件需求
- [PlatformIO](https://platformio.org/)（推荐 CLion 插件）
- 驱动库依赖：U8g2、RTClib、MCP_CAN（已在 `platformio.ini` 配置）

---

## 三、硬件接线说明

### ESP32 主控板接线图

### OLED 屏幕（U8G2库，I2C接口）
- **SCL（时钟）**：GPIO 22
- **SDA（数据）**：GPIO 23
- **RESET**：未连接（U8X8_PIN_NONE）

### 按键配置
- **按钮1**：GPIO 5（带上拉，用于切换页面）
- **按钮2**：GPIO 18（带上拉，用于调整小时）
- **按钮3**：GPIO 19（带上拉，用于调整分钟）

### MCP2515 CAN 总线模块（SPI接口）
| MCP2515 引脚 | ESP32 引脚 | 说明 |
|-------------|-----------|------|
| CS (片选)    | GPIO 15   | SPI 片选 |
| INT (中断)   | GPIO 4    | 中断信号 |
| SI (MOSI)   | GPIO 13   | SPI 数据输入 |
| SO (MISO)   | GPIO 12   | SPI 数据输出 |
| SCK         | GPIO 14   | SPI 时钟 |
| VCC         | 3.3V      | 电源 |
| GND         | GND       | 接地 |

### 实时时钟（RTC，DS3231，I2C接口）
- **SCL**：GPIO 22（与 OLED 共用 I2C 总线）
- **SDA**：GPIO 23（与 OLED 共用 I2C 总线）

### 完整接线表

| 设备/信号        | ESP32 引脚 | 说明           |
|-----------------|----------|---------------|
| OLED SCL        | 22       | I2C 时钟       |
| OLED SDA        | 23       | I2C 数据       |
| 按钮1           | 5        | 上拉输入        |
| 按钮2           | 18       | 上拉输入        |
| 按钮3           | 19       | 上拉输入        |
| MCP2515 CS      | 15       | SPI 片选       |
| MCP2515 INT     | 4        | 中断信号        |
| MCP2515 SI      | 13       | SPI MOSI      |
| MCP2515 SO      | 12       | SPI MISO      |
| MCP2515 SCK     | 14       | SPI 时钟       |
| DS3231 SCL      | 22       | I2C 时钟       |
| DS3231 SDA      | 23       | I2C 数据       |

**注意：**
- MCP2515 模块通过 SPI 接口连接，使用 ESP32 的 HSPI 引脚
- 建议使用带 TJA1050 收发器的 MCP2515 模块
- CAN 总线需要正确连接 CAN-H 和 CAN-L 到车辆 OBD2 接口

---

## 四、按键操作说明

### 按键功能
**处于时钟模式下：**
- **按钮2**：用于调整时钟小时数
- **按钮3**：用于调整分钟数
- **按钮1**：切换页面

### 屏幕模式
系统支持6种显示模式：
- Logo 显示
- 时钟显示
- 油温显示
- 冷却液温度显示
- 油温+冷却液温度显示
- 油压显示

---

## 五、CAN 总线数据说明

### GT86/BRZ/FRS CAN ID 列表

| CAN ID | 数据内容     | 数据字节位置 | 解析公式                    |
|--------|------------|-------------|---------------------------|
| 0x360  | 机油温度    | buf[2]      | 温度 = buf[2] - 40 (°C)    |
| 0x360  | 冷却液温度  | buf[3]      | 温度 = buf[3] - 40 (°C)    |
| 0x134  | 空燃比 (AFR)| buf[0-1]    | AFR = (A*256+B)/32768*14.7 |
| 0x142  | 电压       | buf[0]      | 电压 = buf[0] / 10.0 (V)   |

### CAN 总线参数
- **波特率**：500 Kbps（OBD2 标准）
- **晶振频率**：8 MHz（根据 MCP2515 模块调整）

### 启用 CAN 调试输出
在 `gt86clock.h` 中添加以下定义：
```cpp
#define DEBUG_CAN  // 启用 CAN 调试输出
```

---

## 六、项目结构说明

### 根目录文件

- **platformio.ini**
  PlatformIO 的项目配置文件，定义了开发板类型（esp32dev）、使用的框架（Arduino）、依赖库（如 U8g2、RTClib、MCP_CAN）以及源码目录。

- **MCP2515_CAN_CN.md**
  MCP2515 CAN 总线模块的详细使用文档。

### 主要源码目录 `src/`

- **gt86clock.h / gt86clock.cpp**
  主程序头文件和实现文件，包含全局变量定义、CAN 引脚定义和主要功能实现。

- **setup.cpp**
  硬件初始化代码，包含串口、CAN 总线、RTC 等初始化。

- **loop.cpp**
  主循环逻辑，调用 CAN 数据读取和显示更新。

- **sensors.cpp**
  MCP2515 CAN 总线数据读取和解析模块。

- **screen.cpp**
  屏幕管理和显示控制相关代码。

- **drawClock.cpp**
  时钟界面绘制功能。

- **interrupts.cpp**
  按钮中断服务程序。

- **handleModeButton.cpp**
  按钮模式切换处理逻辑。

- **logos.h**
  图标和 logo 的位图数据定义。

- **my_functions.h**
  自定义函数声明和工具函数。

### 其他目录

- **include/**：头文件目录
- **lib/**：自定义库目录
- **test/**：测试目录
- **.idea/**：CLion/ReSharper C++ IDE 配置目录

---

## 七、编译与上传

1. 使用 CLion 打开本项目文件夹
2. 安装 PlatformIO 插件
3. 连接 ESP32 开发板至电脑
4. 检查 `platformio.ini`，确认开发板型号与端口设置
5. 点击 PlatformIO 的"Build"进行编译
6. 点击"Upload"上传固件

---

## 八、功能说明

### 屏幕与按键操作
- 默认显示时钟、油温、冷却液温度等信息
- 按钮操作详见第四章按键操作说明

### CAN 总线监控
- **温度数据**：通过 CAN ID 0x360 获取机油温度和冷却液温度
- **空燃比**：通过 CAN ID 0x134 获取 AFR 数据
- **电压**：通过 CAN ID 0x142 获取电压数据
- **时钟功能**：DS3231 RTC 提供精确时间

---

## 九、常见问题与注意事项

### CAN 总线问题排查

#### 1. MCP2515 初始化失败
- 检查 SPI 接线是否正确（CS、MOSI、MISO、SCK）
- 确认晶振频率参数与模块实际晶振匹配（默认 8MHz）
- 检查模块供电是否正常（3.3V）

#### 2. 收不到 CAN 数据
- 确认 CAN 总线波特率正确（OBD2 通常为 500Kbps）
- 检查 CAN-H 和 CAN-L 接线是否正确
- 使用调试模式查看原始 CAN 消息
- 检查过滤器配置是否正确

#### 3. 数据解析错误
- 不同车型的 CAN ID 和数据格式可能不同
- 启用 `DEBUG_CAN` 宏打印原始数据进行分析
- 参考车辆的 CAN 数据库文档

### 其他问题

- **库依赖**：首次编译会自动下载依赖库，若失败请检查网络或手动安装
- **时钟不准确**：检查 DS3231 模块连接
- **显示异常**：检查 I2C 接线和 OLED 地址

### 开发建议
- 使用串口监视器查看调试信息（波特率 115200）
- 首次使用时建议禁用 CAN 过滤器进行调试
- 根据实际车辆调整 CAN ID 和解析公式

---

## 十、技术参数

### 硬件规格
- **主控**：ESP32-WROOM-32
- **显示**：128x32 OLED（I2C）
- **CAN 模块**：MCP2515 + TJA1050
- **时钟**：DS3231 RTC（±2ppm 精度）

### 软件特性
- **看门狗**：60秒硬件看门狗防死机
- **中断**：按钮中断响应
- **多任务**：Arduino 框架 + FreeRTOS
- **CAN 过滤**：支持 6 个 CAN ID 过滤器

### CAN 总线参数
- **波特率**：500 Kbps
- **帧类型**：标准帧 + 扩展帧
- **晶振**：8 MHz

---

## 十一、参考与扩展

- 项目开源地址：[Github](https://github.com/mg-arne/gt86clock)
- MCP_CAN 库：https://github.com/coryjfowler/MCP_CAN_lib
- OBD2 PID 列表：https://en.wikipedia.org/wiki/OBD-II_PIDs
- 可根据实际需求扩展更多 CAN ID 的解析

---

**版权说明：** 本项目基于开源协议，欢迎改进和扩展。使用时请注意安全，确保正确接线以避免损坏设备。
