# GT86 ESP32 传感器系统说明文档

## 📋 目录
- [硬件连接](#硬件连接)
- [传感器类型和参数](#传感器类型和参数)
- [调试模式](#调试模式)
- [校准方法](#校准方法)
- [故障排查](#故障排查)

---

## 🔌 硬件连接

### 电路原理图
```
              +3.3V (ESP32供电)
                 │
                 │
              R_pullup
         (470Ω NTC / 180Ω 油压)
                 │
                 │
                 ├───────► ESP32 ADC引脚
                 │         (GPIO 32/33/34/35)
                 │
           R_sensor (传感器)
           (NTC / 电阻式)
                 │
                 │
                GND
```

### 引脚分配表

| 传感器类型 | ESP32引脚 | ADC通道 | 上拉电阻 | 传感器类型 |
|---------|----------|---------|---------|----------|
| **油压传感器** | GPIO 33 | ADC1_CH5 | 180Ω | 电阻式 (10-184Ω) |
| **油温传感器** | GPIO 34 | ADC1_CH6 | 470Ω | NTC (24-673Ω) |
| **涡轮压力** | GPIO 32 | ADC1_CH4 | 待定 | 待定 |
| **水温传感器** | GPIO 35 | ADC1_CH7 | 470Ω | NTC (24-673Ω) |

> ⚠️ **重要提示：** 所有传感器引脚使用 **ADC1** 通道，与WiFi功能兼容。

---

## 🌡️ 传感器类型和参数

### 1️⃣ NTC温度传感器（油温/水温）

#### 技术参数
- **传感器型号：** 车用NTC温度传感器
- **测量范围：** -40℃ ~ 150℃
- **阻值特性：**
  - 20℃ → 673Ω
  - 120℃ → 24Ω
- **β值：** 3380 (可根据实际传感器调整)

#### 工作原理
- 采用 **Steinhart-Hart β值方程** 进行温度计算
- 公式：`1/T = 1/T₀ + (1/β) × ln(R/R₀)`
- 分压电路：`Vout = 3.3V × R_NTC / (470Ω + R_NTC)`

#### 电压-温度对照表

| 温度 (℃) | NTC阻值 (Ω) | 预期电压 (V) | ADC值 (12bit) |
|---------|------------|-------------|--------------|
| -40     | ~48000     | ~3.27       | ~4060        |
| 0       | ~3500      | ~2.91       | ~3610        |
| 20      | 673        | ~1.94       | ~2407        |
| 40      | 195        | ~0.97       | ~1204        |
| 60      | 73         | ~0.44       | ~546         |
| 80      | 33         | ~0.22       | ~273         |
| 100     | 17         | ~0.12       | ~149         |
| 120     | 24         | ~0.16       | ~198         |

---

### 2️⃣ 油压传感器（电阻式）

#### 技术参数
- **传感器型号：** 车用电阻式油压传感器
- **测量范围：** 0 ~ 10 bar
- **阻值特性：**
  - 0 bar → 10Ω
  - 10 bar → 184Ω
- **线性度：** 线性映射

#### 工作原理
- 线性电阻变化
- 公式：`pressure_bar = (R - 10) / (184 - 10) × 10`
- 分压电路：`Vout = 3.3V × R_sensor / (180Ω + R_sensor)`

#### 电压-压力对照表

| 压力 (bar) | 传感器阻值 (Ω) | 预期电压 (V) | ADC值 (12bit) |
|-----------|--------------|-------------|--------------|
| 0.0       | 10           | 0.17        | ~211         |
| 1.0       | 27           | 0.43        | ~533         |
| 2.0       | 45           | 0.66        | ~818         |
| 3.0       | 62           | 0.85        | ~1054        |
| 4.0       | 79           | 1.01        | ~1253        |
| 5.0       | 97           | 1.16        | ~1438        |
| 6.0       | 114          | 1.28        | ~1588        |
| 7.0       | 131          | 1.39        | ~1724        |
| 8.0       | 149          | 1.50        | ~1860        |
| 9.0       | 166          | 1.59        | ~1972        |
| 10.0      | 184          | 1.68        | ~2083        |

---

## 🐛 调试模式

### 启用调试输出

在 `gt86clock.h` 中添加以下定义（编译前）：

```cpp
#define DEBUG_SENSORS  // 启用传感器调试输出
```

### 调试信息示例

启用调试模式后，串口监视器（115200波特率）将输出：

```
[油温] ADC=546, V=0.44V, R=73.2Ω, T=60℃
[水温] ADC=2407, V=1.94V, R=672.8Ω, T=20℃
[油压] ADC=1438, V=1.16V, R=97.1Ω, P=5.0 bar
[涡轮] ADC=2048, V=1.65V, P=100 kPa
```

### 串口监视器配置

```bash
# PlatformIO
pio device monitor -b 115200

# Arduino IDE
工具 → 串口监视器 → 波特率选择 115200
```

---

## 🔧 校准方法

### 方法1：使用已知温度校准 NTC 传感器

#### 步骤：

1. **准备工具**
   - 数字万用表（测量阻值）
   - 温度计（精度 ±0.5℃）
   - 恒温水浴或冰水混合物

2. **测量两个校准点**

   **校准点1：冰水混合物（0℃）**
   ```
   - 将NTC传感器浸入冰水混合物
   - 等待5分钟稳定
   - 用万用表测量传感器阻值 → 记录 R₀
   ```

   **校准点2：沸水（100℃，海平面）**
   ```
   - 将NTC传感器浸入沸水
   - 等待5分钟稳定
   - 用万用表测量传感器阻值 → 记录 R₁₀₀
   ```

3. **计算β值**

   使用公式：
   ```
   β = (T₀ × T₁) / (T₁ - T₀) × ln(R₀ / R₁)
   ```
   其中：
   - T₀ = 273.15K (0℃)
   - T₁ = 373.15K (100℃)
   - R₀ = 0℃时阻值
   - R₁ = 100℃时阻值

4. **更新代码中的参数**

   修改 `gt86clock.h`:
   ```cpp
   #define NTC_BETA        3380.0      // 替换为计算出的β值
   #define NTC_R_AT_20C    673.0       // 替换为20℃时实测阻值
   #define NTC_T0_KELVIN   293.15      // 参考温度（20℃ = 293.15K）
   ```

---

### 方法2：油压传感器校准

#### 步骤：

1. **测量0 bar时的阻值**
   - 传感器未连接压力源（常压）
   - 用万用表测量阻值 → 记录为 R_min

2. **测量满量程时的阻值**
   - 传感器接入已知压力（如10 bar）
   - 用万用表测量阻值 → 记录为 R_max

3. **更新代码中的参数**

   修改 `gt86clock.h`:
   ```cpp
   #define OIL_PRESSURE_R_MIN      10.0    // 替换为R_min
   #define OIL_PRESSURE_R_MAX      184.0   // 替换为R_max
   #define OIL_PRESSURE_MAX        10.0    // 传感器满量程压力值
   ```

---

### 方法3：使用ADC原始值直接校准

如果无法测量传感器阻值，可以直接使用ADC值校准：

#### 步骤：

1. **启用调试模式** (`#define DEBUG_SENSORS`)

2. **记录已知状态的ADC值**
   - 例如：室温20℃时，记录油温ADC值
   - 例如：发动机关闭（0 bar）时，记录油压ADC值

3. **使用查表法替换公式**

   在 `sensors.cpp` 中创建查表函数：
   ```cpp
   int adcToTemperature_LookupTable(int adcValue) {
       // 查表+线性插值
       const int lookupTable[][2] = {
           {198,  120},  // ADC值 → 温度℃
           {273,  80},
           {546,  60},
           {1204, 40},
           {2407, 20},
           {3610, 0}
       };
       // 实现线性插值逻辑...
   }
   ```

---

## ❗ 故障排查

### 问题1：读数始终为0或异常值

**可能原因：**
- 传感器未正确连接
- 上拉电阻值错误
- ADC引脚配置错误

**解决方法：**
1. 检查硬件连接
2. 用万用表测量分压点电压
3. 启用调试模式查看原始ADC值
4. 验证 `gt86clock.h` 中的引脚定义

---

### 问题2：温度读数不稳定/跳动

**可能原因：**
- ADC噪声
- 电源纹波
- 线缆干扰

**解决方法：**
1. 增加滤波采样次数：
   ```cpp
   #define ADC_SAMPLES  20  // 从10增加到20
   ```
2. 在传感器线缆上加磁环
3. 增加去耦电容（0.1μF）在ADC引脚附近

---

### 问题3：高温时读数不准确

**可能原因：**
- NTC β值不匹配
- 参考温度点偏差

**解决方法：**
1. 重新测量并计算β值（参考校准方法1）
2. 使用查表法替代公式计算
3. 增加多点校准

---

### 问题4：油压读数偏差大

**可能原因：**
- 上拉电阻值偏差
- 传感器阻值范围不匹配

**解决方法：**
1. 用万用表精确测量上拉电阻实际值
2. 更新代码中的 `OIL_PRESSURE_PULLUP_R`
3. 校准 `OIL_PRESSURE_R_MIN` 和 `R_MAX`

---

## 📊 性能指标

| 参数 | 值 |
|-----|---|
| **ADC分辨率** | 12位 (0-4095) |
| **采样频率** | 2 Hz (每500ms) |
| **滤波方式** | 移动平均 (10次采样) |
| **温度精度** | ±2℃ (校准后) |
| **压力精度** | ±0.2 bar |
| **响应时间** | <1秒 |

---

## 🔄 代码文件说明

| 文件 | 功能 |
|-----|------|
| `sensors.cpp` | 传感器读取和数据处理 |
| `gt86clock.h` | 引脚定义、校准参数配置 |
| `setup.cpp` | ADC硬件初始化 |
| `loop.cpp` | 主循环中调用传感器更新 |
| `my_functions.h` | 函数声明 |

---

## 📝 修改历史

| 日期 | 版本 | 修改内容 |
|-----|------|---------|
| 2025-10-27 | v1.0 | 初始版本，实现NTC温度和油压传感器 |

---

## 🆘 技术支持

如有问题，请查看：
1. 串口调试输出 (115200波特率)
2. 检查 `#define DEBUG_SENSORS` 是否启用
3. 验证硬件连接和上拉电阻值

---

**祝调试顺利！🚗💨**
